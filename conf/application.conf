play.modules.enabled += "modules.OutboxModule"

# HTTP endpoints to use local simulator
outbox.http {
  # Point to local simulator instead of external service 
  baseUrl = "http://localhost:9000/simulator"

  # Default endpoint - randomly fails 30% of the time
  defaultUrl = "http://localhost:9000/simulator/webhook/default"
  defaultMethod = "POST"

  defaultHeaders {
    "X-Service" = "outbox-local-test"
  }

  # Event-specific routes using simulator
  routes {
    OrderCreated {
      url = "http://localhost:9000/simulator/webhook/orders/created"
      method = "POST"
      timeout = 5 seconds
    }

    OrderStatusUpdated {
      url = "http://localhost:9000/simulator/webhook/orders/status"
      method = "PUT"
      timeout = 5 seconds
    }

    OrderCancelled {
      # Test with endpoint that always succeeds
      url = "http://localhost:9000/simulator/always-succeed"
      method = "POST"
      timeout = 5 seconds
    }
  }
}

outbox {
  pollInterval = 2 seconds  # Polling interval when LISTEN/NOTIFY is disabled
  batchSize = 100
  poolSize = 10
  maxRetries = 2  # Number of retry attempts before moving to DLQ
  useListenNotify = true  # Enable PostgreSQL LISTEN/NOTIFY for near-instant processing (default: true)
  # When enabled, new events are processed instantly via LISTEN/NOTIFY
  # Failed events and full batches trigger immediate reprocessing (100ms)

  # Stale event recovery settings
  enableStaleEventCleanup = true  # Enable automatic recovery of stale PROCESSING events (default: true)
  staleEventTimeoutMinutes = 5    # Consider events stale after this many minutes (default: 5)
  cleanupInterval = 1 minute      # How often to run cleanup (default: 1 minute)
}

simulator {
  failureRate = 0.5  # 50% failure rate
  slowResponseRate = 0.3  # 30% slow responses
  slowResponseDelayMs = 1000  # 1 second delay
}

slick {
  dbs {
    default {
      profile = "slick.jdbc.PostgresProfile$"
      db {
        connectionPool = "HikariCP"
        driver = "org.postgresql.Driver"
        url = "jdbc:postgresql://localhost:5432/outbox_db"
        user = "outbox_user"
        password = "outbox_pass"
        numThreads = 25
        maximumPoolSize = 25
        minimumIdle = 0
      }
    }
  }
}

blocking-jdbc {
  type = Dispatcher
  executor = "thread-pool-executor"
  thread-pool-executor { fixed-pool-size = 4 }
  throughput = 10
}

